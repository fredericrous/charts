name: Release Chart on PR Merge

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  trigger-release:
    name: Trigger Chart Release
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'chart-update')
    runs-on: ubuntu-latest
    permissions:
      actions: write  # Required to dispatch workflow_dispatch

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract chart info from PR
        id: extract
        run: |
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"

          # Extract chart name and version from branch name
          # Format: update-{chart-name}-{version}
          if [[ "$PR_BRANCH" =~ ^update-([a-zA-Z0-9-]+)-([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            CHART_NAME="${BASH_REMATCH[1]}"
            VERSION="${BASH_REMATCH[2]}"
            echo "chart_name=$CHART_NAME" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Chart: $CHART_NAME"
            echo "Version: $VERSION"
          else
            echo "::error::Could not parse chart info from branch: $PR_BRANCH"
            exit 1
          fi

      - name: Verify chart version in Chart.yaml
        run: |
          CHART_NAME="${{ steps.extract.outputs.chart_name }}"
          EXPECTED="${{ steps.extract.outputs.version }}"
          CHART_VERSION=$(yq '.version' "./charts/$CHART_NAME/Chart.yaml")

          if [ "$CHART_VERSION" != "$EXPECTED" ]; then
            echo "::error::Chart.yaml version ($CHART_VERSION) does not match expected ($EXPECTED)"
            exit 1
          fi
          echo "Chart.yaml version matches: $CHART_VERSION"

      - name: Trigger chart release workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CHART="${{ steps.extract.outputs.chart_name }}"
          VERSION="v${{ steps.extract.outputs.version }}"

          echo "Dispatching helm-release.yaml for $CHART $VERSION..."
          gh workflow run helm-release.yaml \
            --field chart="$CHART" \
            --field version="$VERSION"

          echo "âœ… Dispatched release workflow for $CHART $VERSION"
          echo "Monitor: https://github.com/${{ github.repository }}/actions/workflows/helm-release.yaml"
