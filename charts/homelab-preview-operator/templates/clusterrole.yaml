apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "homelab-preview-operator.fullname" . }}
  labels:
    {{- include "homelab-preview-operator.labels" . | nindent 4 }}
rules:
  # Core resources
  - apiGroups:
      - ""
    resources:
      - namespaces
      - secrets
      - configmaps
      - services
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
  - apiGroups:
      - ""
    resources:
      - persistentvolumeclaims
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  - apiGroups:
      - ""
    resources:
      - events
    verbs:
      - create
      - patch
  # Leader election
  - apiGroups:
      - coordination.k8s.io
    resources:
      - leases
    verbs:
      - create
      - get
      - list
      - update
  # Flux Kustomizations (watch for preview triggers)
  - apiGroups:
      - kustomize.toolkit.fluxcd.io
    resources:
      - kustomizations
    verbs:
      - get
      - list
      - watch
  # Flux GitRepositories
  - apiGroups:
      - source.toolkit.fluxcd.io
    resources:
      - gitrepositories
    verbs:
      - get
      - list
      - watch
  # Flux HelmReleases (for patching)
  - apiGroups:
      - helm.toolkit.fluxcd.io
    resources:
      - helmreleases
    verbs:
      - get
      - list
      - watch
      - update
      - patch
  # OIDC Clients
  - apiGroups:
      - security.homelab.io
    resources:
      - oidcclients
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  # CNPG Clusters (for database cloning)
  - apiGroups:
      - postgresql.cnpg.io
    resources:
      - clusters
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  # Redis (opstree operator)
  - apiGroups:
      - redis.redis.opstreelabs.in
    resources:
      - redis
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  # Deployments (for patching)
  - apiGroups:
      - apps
    resources:
      - deployments
    verbs:
      - get
      - list
      - watch
      - update
      - patch
  # VolumeSnapshots
  - apiGroups:
      - snapshot.storage.k8s.io
    resources:
      - volumesnapshots
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  # VolumeSnapshotContents (cluster-scoped)
  - apiGroups:
      - snapshot.storage.k8s.io
    resources:
      - volumesnapshotcontents
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
